# Implementation Plan: Manual Work Order Entry

**Branch**: `001-manual-work-order-entry` | **Date**: 2025-10-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-manual-work-order-entry/spec.md`

**Note**: This document is generated by the `/speckit.plan` command.

## Summary

This feature enables users with the `client_admin` role (tenancy managers) to manually create and edit work orders directly in the VisionWest system. Currently, all work orders must flow through the n8n email automation workflow. This feature provides an alternative entry point for urgent requests, phone-in orders, and other non-email scenarios while maintaining the same data structure and notification flow as automated work orders.

**Technical Approach**: Build mobile-first React forms for work order creation and editing in the frontend, add new protected API endpoints in the backend with role-based access control for `client_admin` users, reuse existing work order data model with a new `work_order_type` discriminator field value ("manual"), leverage existing notification infrastructure, and send email notifications to mark@williamspropertyservices.co.nz when new work orders are created.

## Technical Context

**Language/Version**: Node.js 18.x (backend), React 19+ (frontend)
**Primary Dependencies**: Express 4.x, Sequelize 6.x, PostgreSQL (backend); React 19, Vite 6.x, Tailwind CSS 3.x, React Router 7.x (frontend)
**Storage**: PostgreSQL for relational data (work orders, users, notes, notifications); AWS S3 for file uploads (photos)
**Testing**: Manual validation on physical mobile devices; backend endpoint testing with curl/Postman; frontend responsive testing at 320px, 375px, 390px, 414px breakpoints
**Target Platform**: Web application - mobile-first responsive PWA (iOS Safari, Android Chrome primary targets); Backend hosted on Render; Frontend hosted on Netlify
**Project Type**: Web application (separate frontend and backend)
**Performance Goals**: Form submission < 500ms API response time; work order appears in list within 5 seconds; notifications delivered within 10 seconds; mobile form usable on 3G connection
**Constraints**: Must work offline (PWA caching); must not break n8n webhook integration; must enforce role-based access (client_admin only for creation/editing); touch targets minimum 44x44px; responsive at 320px minimum width; must send email notification to mark@williamspropertyservices.co.nz for every new work order created
**Scale/Scope**: Approximately 10-50 client_admin users creating manual work orders; estimated 20-30% of total work orders will be manual (majority still via email automation); existing database already handles 100s of work orders

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Mobile-First Design (NON-NEGOTIABLE) ✅ PASS

**Compliance**: This feature explicitly requires mobile-first implementation per spec assumptions section. The work order creation form will be designed for smartphone screens first, with touch-friendly inputs (minimum 44x44px touch targets). Tenancy managers often create work orders while on-site, making mobile usability critical.

**Validation**:
- Form fields will use large touch-friendly inputs
- Buttons sized for thumb navigation
- Responsive breakpoints tested at 320px, 375px, 390px, 414px
- Testing required on physical mobile devices before deployment

### Principle II: Progressive Enhancement & Offline Capability ✅ PASS

**Compliance**: Manual work order creation should support offline capabilities via PWA service worker caching. While creation requires server connectivity (to assign work order IDs and send notifications), the form interface itself should load offline. Edit functionality can potentially queue changes for sync when connectivity returns.

**Considerations**:
- Form UI cached for offline viewing
- Creation requires online connectivity (acceptable limitation)
- Edit changes can be queued for sync when reconnected
- Duplicate job number validation requires online check

### Principle III: Integration Integrity ✅ PASS

**Compliance**: This feature adds NEW endpoints and does NOT modify existing n8n webhook endpoints. The existing webhook integration at `/api/webhook/work-orders` remains untouched. Manual work orders use the same data model with a different `work_order_type` value, ensuring compatibility.

**Protected Endpoints (unchanged)**:
- POST `/api/webhook/work-orders` - unchanged
- PUT `/api/webhook/work-orders` - unchanged
- POST `/api/webhook/work-orders/notes` - unchanged

**New Endpoints (non-breaking)**:
- POST `/api/work-orders` - new manual creation endpoint
- PUT `/api/work-orders/:id` - new manual edit endpoint
- GET `/api/work-orders/suggestions` - new autocomplete endpoint (P3)

### Principle IV: User Story-Driven Development ✅ PASS

**Compliance**: Feature specification includes 3 prioritized user stories:
- P1: Create Work Order Manually (MVP - independent delivery)
- P2: Edit Work Order Fields (builds on P1 - independent delivery)
- P3: Attach Property and Supplier Details (enhancement - independent delivery)

Each story is independently testable and deliverable per constitution requirements.

### Principle V: Security & Data Protection ✅ PASS

**Compliance**: All new endpoints require JWT authentication and enforce role-based access control (RBAC) limiting manual work order creation to `client_admin` role. Sequelize ORM provides SQL injection protection. Work order data (including sensitive property and tenant information) protected by existing authentication middleware.

**Security Measures**:
- JWT authentication required on all new endpoints
- Role check middleware verifies `client_admin` role
- Input validation on all form fields
- Sequelize ORM parameterization prevents SQL injection
- Audit trail via work order notes for edit tracking

### Gate Results

✅ **ALL GATES PASSED** - No constitutional violations. Feature aligns with all 5 core principles.

No complexity justification required.

## Project Structure

### Documentation (this feature)

```
specs/001-manual-work-order-entry/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Research findings (Phase 0)
├── data-model.md        # Data model details (Phase 1)
├── quickstart.md        # Developer guide (Phase 1)
├── contracts/           # API contracts (Phase 1)
│   ├── create-work-order.md
│   ├── edit-work-order.md
│   └── autocomplete-suggestions.md
└── checklists/
    └── requirements.md  # Spec quality checklist
```

### Source Code (repository root)

```
backend/
├── server.js           # Express app entry point
├── config/             # Database, auth configuration
├── models/             # Sequelize models (existing work order model)
│   └── workOrder.model.js  # May need minor update for work_order_type
├── routes/             # Express route handlers
│   └── workOrder.routes.js  # NEW routes for manual work order operations
├── controllers/        # Business logic
│   └── workOrder.controller.js  # NEW/UPDATED: manual create/edit logic
├── middleware/         # Auth, error handling
│   └── auth.middleware.js  # Existing role check middleware
└── utils/              # Shared utilities

frontend/
├── src/
│   ├── components/     # Reusable UI components
│   │   └── WorkOrderForm.jsx  # NEW: Reusable form component
│   ├── pages/          # Route-level components
│   │   ├── CreateWorkOrder.jsx  # NEW: Manual creation page
│   │   ├── EditWorkOrder.jsx    # NEW: Edit work order page
│   │   └── WorkOrderList.jsx    # UPDATED: Add "Create" button
│   ├── context/        # React Context providers
│   │   └── AuthContext.jsx  # Existing auth context for role checks
│   └── services/       # API client utilities
│       └── workOrderService.js  # NEW/UPDATED: API calls for manual ops
└── public/             # Static assets, PWA manifest
```

**Structure Decision**: This project follows the established web application structure with separate `backend/` and `frontend/` directories. Both manual work order creation (frontend form + backend API) and editing (frontend form + backend API) will be implemented across these two codebases. The feature integrates with existing authentication, database models, and notification systems.

## Complexity Tracking

*No constitutional violations - this section intentionally left empty.*

## Email Notification Requirements

When a new work order is created via the manual entry form (POST /api/work-orders), the system MUST send an email notification to:

**Recipient**: mark@williamspropertyservices.co.nz

**Email Content**:
- Subject: New Work Order Created - [job_no]
- Work order details: job number, property name, supplier name, description
- Link to view work order in the system
- Indication that work order was manually created (vs. email automation)

**Implementation Notes**:
- Email sending should happen asynchronously (non-blocking)
- Failure to send email should not prevent work order creation
- Email should be sent AFTER work order is successfully saved to database
- Consider using existing email service/library if available in the project
- Log email sending success/failure for troubleshooting

**Technical Approach**:
- Use Node.js email library (nodemailer recommended)
- Email configuration (SMTP settings) stored in environment variables
- Email template can be plain text or HTML with work order details
- Recipient email address configurable via environment variable for different environments

---

**Next Phase**: Phase 0 - Research (see research.md)
